/*! For license information please see three-utils.min.js.LICENSE.txt */
import{AmbientLight as e,AnimationClip as t,Audio as n,AudioListener as s,AudioLoader as r,Bone as o,Box3 as i,BufferAttribute as a,BufferGeometry as c,ClampToEdgeWrapping as l,Color as u,ColorManagement as h,Curve as p,DirectionalLight as d,DoubleSide as f,EquirectangularReflectionMapping as m,Euler as g,FileLoader as v,Float32BufferAttribute as y,FrontSide as T,Group as x,ImageBitmapLoader as w,InstancedBufferAttribute as A,InstancedMesh as b,InterleavedBuffer as I,InterleavedBufferAttribute as R,Interpolant as M,InterpolateDiscrete as S,InterpolateLinear as E,Line as _,LineBasicMaterial as N,LineLoop as L,LineSegments as P,LinearFilter as C,LinearMipmapLinearFilter as O,LinearMipmapNearestFilter as k,LinearSRGBColorSpace as D,Loader as F,LoaderUtils as U,Material as j,MathUtils as H,Matrix3 as B,Matrix4 as V,Mesh as G,MeshBasicMaterial as z,MeshLambertMaterial as K,MeshPhongMaterial as X,MeshPhysicalMaterial as W,MeshStandardMaterial as q,MirroredRepeatWrapping as Y,NearestFilter as $,NearestMipmapLinearFilter as Z,NearestMipmapNearestFilter as J,NumberKeyframeTrack as Q,Object3D as ee,OrthographicCamera as te,PerspectiveCamera as ne,PointLight as se,Points as re,PointsMaterial as oe,PositionalAudio as ie,PropertyBinding as ae,Quaternion as ce,QuaternionKeyframeTrack as le,RepeatWrapping as ue,SRGBColorSpace as he,ShapeUtils as pe,Skeleton as de,SkinnedMesh as fe,Sphere as me,SphereGeometry as ge,SpotLight as ve,Texture as ye,TextureLoader as Te,TriangleFanDrawMode as xe,TriangleStripDrawMode as we,TrianglesDrawMode as Ae,Uint16BufferAttribute as be,Vector2 as Ie,Vector3 as Re,Vector4 as Me,VectorKeyframeTrack as Se}from"THREE";var Ee={d:(e,t)=>{for(var n in t)Ee.o(t,n)&&!Ee.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},_e={};Ee.r(_e),Ee.d(_e,{CallLimits:()=>Ue,callWithReducer:()=>He,clearAllCallReducerData:()=>Ve,clearCallReducerData:()=>Be});var Ne={};Ee.r(Ne),Ee.d(Ne,{deepDispose:()=>ze,disposeMaterials:()=>Ge});var Le={};Ee.r(Le),Ee.d(Le,{deepMerge:()=>Xe,getObjectDiff:()=>We,patchObject:()=>Ke});var Pe={};Ee.r(Pe),Ee.d(Pe,{TimePattern:()=>qe,formatTime:()=>$e});var Ce={};Ee.r(Ce),Ee.d(Ce,{getUniqueId:()=>Je});var Oe={};Ee.r(Oe),Ee.d(Oe,{absVector3:()=>Qe});var ke={};Ee.r(ke),Ee.d(ke,{isPointInATriangle:()=>tt,sign:()=>et,yFromTriangle:()=>nt});var De={};Ee.r(De),Ee.d(De,{disposeAssets:()=>js,getAudioBuffer:()=>Ds,getFBXModel:()=>Es,getFBXSkeletonAnimation:()=>Ns,getGLTFModel:()=>Ps,getTexture:()=>Os,loadAssets:()=>Hs,registerAudioBuffer:()=>ks,registerFBXModel:()=>Ss,registerFBXSkeletonAnimation:()=>_s,registerGLTFModel:()=>Ls,registerTexture:()=>Cs});var Fe={};Ee.r(Fe),Ee.d(Fe,{default:()=>er,getAudioCache:()=>Ys,playAudio:()=>Ws,setAudioConfig:()=>Xs,setEffectsVolume:()=>Qs,setMasterVolume:()=>Zs,setMusicVolume:()=>Js,stopAudio:()=>qs});const Ue={NO_LIMIT:-1,CALL_1_PER_SECONDS:1e3,CALL_15_PER_SECONDS:1e3/15,CALL_30_PER_SECONDS:1e3/30,CALL_45_PER_SECONDS:1e3/45,CALL_60_PER_SECONDS:1e3/60,CALL_120_PER_SECONDS:1e3/120};let je={};const He=({id:e,callback:t,callLimit:n,elapsed:s,callbackParam:r,forceCallCount:o=!1})=>{if(!s)return;je[e]||(je[e]={lastUpdate:-1,callCount:0});const i=()=>{r?t(r):t()};if(n!==Ue.NO_LIMIT)if(o){const t=Math.floor(s/(1e3*n));for(;-1===je[e].lastUpdate||t>je[e].callCount;)i(),je[e].lastUpdate+=n,je[e].callCount++;je[e].lastUpdate=s}else(-1===je[e].lastUpdate||s-je[e].lastUpdate>=n)&&(i(),je[e].lastUpdate=s);else i()},Be=e=>delete je[e],Ve=()=>{je={}},Ge=e=>{if(e.isMaterial){const t=e;t.map?.dispose(),t.map=null,t.dispose()}else e.forEach(Ge)},ze=e=>{const{isMesh:t,material:n,geometry:s}=e;t?(n&&(Ge(n),e.material=null),s&&(s.dispose(),e.geometry=null),e.parent?.remove(e)):e.children&&(e.children.forEach(ze),e.parent?.remove(e))},Ke=(e,t,n={skippedProperties:[],applyToFirstObject:!1})=>{const s={};return Object.keys(e).forEach(r=>{n.skippedProperties&&n.skippedProperties.includes(r)||("object"==typeof e[r]&&e[r]&&t[r]&&!Array.isArray(e[r])?s[r]=Ke(e[r],t[r],n):(s[r]=0===t[r]?0:!1!==t[r]&&(t[r]||e[r]),n.applyToFirstObject&&(e[r]=s[r])))}),s},Xe=(e,t,n={skippedProperties:[],applyToFirstObject:!1})=>{const s={};return Array.from(new Set([...Object.keys(e||{}),...Object.keys(t||{})])).forEach(r=>{n.skippedProperties&&n.skippedProperties.includes(r)||("object"==typeof e?.[r]&&e?.[r]&&t?.[r]&&!Array.isArray(e[r])?s[r]=Xe(e[r],t[r],n):(s[r]=0===t?.[r]?0:!1!==t?.[r]&&(t?.[r]||e?.[r]),n.applyToFirstObject&&(e[r]=s[r])))}),s},We=(e,t,n={skippedProperties:[]})=>{const s={};return Object.keys(e).forEach(r=>{if(!n.skippedProperties||!n.skippedProperties.includes(r))if("object"==typeof e[r]&&e[r]&&t[r]&&!Array.isArray(e[r])){const o=We(e[r],t[r],n);Object.keys(o).length>0&&(s[r]=o)}else{const n=0===t[r]?0:t[r]||e[r];n!==e[r]&&(s[r]=n)}}),s},qe={HH_MM_SS:"HH:MM:SS",MM_SS:"MM:SS",MM_SS_MS:"MM:SS.MS"},Ye=[{pattern:"HH",routine:({hours:e})=>String(e).padStart(2,"0")},{pattern:"MM",routine:({minutes:e})=>String(e).padStart(2,"0")},{pattern:"SS",routine:({seconds:e})=>String(e).padStart(2,"0")},{pattern:"MS",routine:({milliseconds:e})=>String(e).padStart(3,"0")}],$e=(e,t)=>{const n=Math.floor(e%1e3),s=Math.floor(e/1e3%60),r=Math.floor(Math.floor(e/1e3/60)%60),o={hours:Math.floor(Math.floor(e/1e3/60)/60%24),minutes:r,seconds:s,milliseconds:n};let i=t;return Ye.forEach(({pattern:e,routine:t})=>i=i.replace(e,t(o))),i};let Ze=0;const Je=()=>Ze++,Qe=e=>(e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e),et=(e,t,n)=>(e.x-n.x)*(t.z-n.z)-(t.x-n.x)*(e.z-n.z),tt=(e,t,n,s)=>{const r=et(e,t,n),o=et(e,n,s),i=et(e,s,t);return!((r<0||o<0||i<0)&&(r>0||o>0||i>0))},nt=(e,t,n,s)=>{const r=(n.x-t.x)*(s.y-t.y)-(s.x-t.x)*(n.y-t.y),o=(n.x-t.x)*(s.z-t.z)-(s.x-t.x)*(n.z-t.z),i=(n.z-t.z)*(s.y-t.y)-(s.z-t.z)*(n.y-t.y),a=(n.x-t.x)*(s.z-t.z)-(s.x-t.x)*(n.z-t.z);return t.y+r/o*(e.z-t.z)-i/a*(e.x-t.x)};function st(e){const t=new Map,n=new Map,s=e.clone();return rt(e,s,function(e,s){t.set(s,e),n.set(e,s)}),s.traverse(function(e){if(!e.isSkinnedMesh)return;const s=e,r=t.get(e),o=r.skeleton.bones;s.skeleton=r.skeleton.clone(),s.bindMatrix.copy(r.bindMatrix),s.skeleton.bones=o.map(function(e){return n.get(e)}),s.bind(s.skeleton,s.bindMatrix)}),s}function rt(e,t,n){n(e,t);for(let s=0;s<e.children.length;s++)rt(e.children[s],t.children[s],n)}var ot=Uint8Array,it=Uint16Array,at=Int32Array,ct=new ot([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),lt=new ot([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ut=new ot([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ht=function(e,t){for(var n=new it(31),s=0;s<31;++s)n[s]=t+=1<<e[s-1];var r=new at(n[30]);for(s=1;s<30;++s)for(var o=n[s];o<n[s+1];++o)r[o]=o-n[s]<<5|s;return{b:n,r}},pt=ht(ct,2),dt=pt.b,ft=pt.r;dt[28]=258,ft[258]=28;for(var mt=ht(lt,0),gt=mt.b,vt=(mt.r,new it(32768)),yt=0;yt<32768;++yt){var Tt=(43690&yt)>>1|(21845&yt)<<1;Tt=(61680&(Tt=(52428&Tt)>>2|(13107&Tt)<<2))>>4|(3855&Tt)<<4,vt[yt]=((65280&Tt)>>8|(255&Tt)<<8)>>1}var xt=function(e,t,n){for(var s=e.length,r=0,o=new it(t);r<s;++r)e[r]&&++o[e[r]-1];var i,a=new it(t);for(r=1;r<t;++r)a[r]=a[r-1]+o[r-1]<<1;if(n){i=new it(1<<t);var c=15-t;for(r=0;r<s;++r)if(e[r])for(var l=r<<4|e[r],u=t-e[r],h=a[e[r]-1]++<<u,p=h|(1<<u)-1;h<=p;++h)i[vt[h]>>c]=l}else for(i=new it(s),r=0;r<s;++r)e[r]&&(i[r]=vt[a[e[r]-1]++]>>15-e[r]);return i},wt=new ot(288);for(yt=0;yt<144;++yt)wt[yt]=8;for(yt=144;yt<256;++yt)wt[yt]=9;for(yt=256;yt<280;++yt)wt[yt]=7;for(yt=280;yt<288;++yt)wt[yt]=8;var At=new ot(32);for(yt=0;yt<32;++yt)At[yt]=5;var bt=xt(wt,9,1),It=xt(At,5,1),Rt=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Mt=function(e,t,n){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(7&t)&n},St=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},Et=function(e){return(e+7)/8|0},_t=function(e,t,n){return(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length),new ot(e.subarray(t,n))},Nt=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Lt=function(e,t,n){var s=new Error(t||Nt[e]);if(s.code=e,Error.captureStackTrace&&Error.captureStackTrace(s,Lt),!n)throw s;return s},Pt=function(e,t,n,s){var r=e.length,o=s?s.length:0;if(!r||t.f&&!t.l)return n||new ot(0);var i=!n,a=i||2!=t.i,c=t.i;i&&(n=new ot(3*r));var l=function(e){var t=n.length;if(e>t){var s=new ot(Math.max(2*t,e));s.set(n),n=s}},u=t.f||0,h=t.p||0,p=t.b||0,d=t.l,f=t.d,m=t.m,g=t.n,v=8*r;do{if(!d){u=Mt(e,h,1);var y=Mt(e,h+1,3);if(h+=3,!y){var T=e[(N=Et(h)+4)-4]|e[N-3]<<8,x=N+T;if(x>r){c&&Lt(0);break}a&&l(p+T),n.set(e.subarray(N,x),p),t.b=p+=T,t.p=h=8*x,t.f=u;continue}if(1==y)d=bt,f=It,m=9,g=5;else if(2==y){var w=Mt(e,h,31)+257,A=Mt(e,h+10,15)+4,b=w+Mt(e,h+5,31)+1;h+=14;for(var I=new ot(b),R=new ot(19),M=0;M<A;++M)R[ut[M]]=Mt(e,h+3*M,7);h+=3*A;var S=Rt(R),E=(1<<S)-1,_=xt(R,S,1);for(M=0;M<b;){var N,L=_[Mt(e,h,E)];if(h+=15&L,(N=L>>4)<16)I[M++]=N;else{var P=0,C=0;for(16==N?(C=3+Mt(e,h,3),h+=2,P=I[M-1]):17==N?(C=3+Mt(e,h,7),h+=3):18==N&&(C=11+Mt(e,h,127),h+=7);C--;)I[M++]=P}}var O=I.subarray(0,w),k=I.subarray(w);m=Rt(O),g=Rt(k),d=xt(O,m,1),f=xt(k,g,1)}else Lt(1);if(h>v){c&&Lt(0);break}}a&&l(p+131072);for(var D=(1<<m)-1,F=(1<<g)-1,U=h;;U=h){var j=(P=d[St(e,h)&D])>>4;if((h+=15&P)>v){c&&Lt(0);break}if(P||Lt(2),j<256)n[p++]=j;else{if(256==j){U=h,d=null;break}var H=j-254;if(j>264){var B=ct[M=j-257];H=Mt(e,h,(1<<B)-1)+dt[M],h+=B}var V=f[St(e,h)&F],G=V>>4;V||Lt(3),h+=15&V;k=gt[G];if(G>3){B=lt[G];k+=St(e,h)&(1<<B)-1,h+=B}if(h>v){c&&Lt(0);break}a&&l(p+131072);var z=p+H;if(p<k){var K=o-k,X=Math.min(k,z);for(K+p<0&&Lt(3);p<X;++p)n[p]=s[K+p]}for(;p<z;++p)n[p]=n[p-k]}}t.l=d,t.p=U,t.b=p,t.f=u,d&&(u=1,t.m=m,t.d=f,t.n=g)}while(!u);return p!=n.length&&i?_t(n,0,p):n.subarray(0,p)},Ct=new ot(0),Ot=function(e,t){return(8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31)&&Lt(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&Lt(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),2+(e[1]>>3&4)};function kt(e,t){return Pt(e.subarray(Ot(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}var Dt="undefined"!=typeof TextDecoder&&new TextDecoder;try{Dt.decode(Ct,{stream:!0})}catch(e){}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;function Ft(e,t,n){const s=n.length-e-1;if(t>=n[s])return s-1;if(t<=n[e])return e;let r=e,o=s,i=Math.floor((r+o)/2);for(;t<n[i]||t>=n[i+1];)t<n[i]?o=i:r=i,i=Math.floor((r+o)/2);return i}function Ut(e,t,n,s){const r=[],o=[],i=[];r[0]=1;for(let a=1;a<=n;++a){o[a]=t-s[e+1-a],i[a]=s[e+a]-t;let n=0;for(let e=0;e<a;++e){const t=i[e+1],s=o[a-e],c=r[e]/(t+s);r[e]=n+t*c,n=s*c}r[a]=n}return r}function jt(e,t){let n=1;for(let t=2;t<=e;++t)n*=t;let s=1;for(let e=2;e<=t;++e)s*=e;for(let n=2;n<=e-t;++n)s*=n;return n/s}function Ht(e,t,n,s,r){const o=function(e,t,n,s,r){const o=r<e?r:e,i=[],a=Ft(e,s,t),c=function(e,t,n,s,r){const o=[];for(let e=0;e<=n;++e)o[e]=0;const i=[];for(let e=0;e<=s;++e)i[e]=o.slice(0);const a=[];for(let e=0;e<=n;++e)a[e]=o.slice(0);a[0][0]=1;const c=o.slice(0),l=o.slice(0);for(let s=1;s<=n;++s){c[s]=t-r[e+1-s],l[s]=r[e+s]-t;let n=0;for(let e=0;e<s;++e){const t=l[e+1],r=c[s-e];a[s][e]=t+r;const o=a[e][s-1]/a[s][e];a[e][s]=n+t*o,n=r*o}a[s][s]=n}for(let e=0;e<=n;++e)i[0][e]=a[e][n];for(let e=0;e<=n;++e){let t=0,r=1;const c=[];for(let e=0;e<=n;++e)c[e]=o.slice(0);c[0][0]=1;for(let o=1;o<=s;++o){let s=0;const l=e-o,u=n-o;e>=o&&(c[r][0]=c[t][0]/a[u+1][l],s=c[r][0]*a[l][u]);const h=e-1<=u?o-1:n-e;for(let e=l>=-1?1:-l;e<=h;++e)c[r][e]=(c[t][e]-c[t][e-1])/a[u+1][l+e],s+=c[r][e]*a[l+e][u];e<=u&&(c[r][o]=-c[t][o-1]/a[u+1][e],s+=c[r][o]*a[e][u]),i[o][e]=s;const p=t;t=r,r=p}}let u=n;for(let e=1;e<=s;++e){for(let t=0;t<=n;++t)i[e][t]*=u;u*=n-e}return i}(a,s,e,o,t),l=[];for(let e=0;e<n.length;++e){const t=n[e].clone(),s=t.w;t.x*=s,t.y*=s,t.z*=s,l[e]=t}for(let t=0;t<=o;++t){const n=l[a-e].clone().multiplyScalar(c[t][0]);for(let s=1;s<=e;++s)n.add(l[a-e+s].clone().multiplyScalar(c[t][s]));i[t]=n}for(let e=o+1;e<=r+1;++e)i[e]=new Me(0,0,0);return i}(e,t,n,s,r);return function(e){const t=e.length,n=[],s=[];for(let r=0;r<t;++r){const t=e[r];n[r]=new Re(t.x,t.y,t.z),s[r]=t.w}const r=[];for(let e=0;e<t;++e){const t=n[e].clone();for(let n=1;n<=e;++n)t.sub(r[e-n].clone().multiplyScalar(jt(e,n)*s[n]));r[e]=t.divideScalar(s[0])}return r}(o)}class Bt extends p{constructor(e,t,n,s,r){super();const o=t?t.length-1:0,i=n?n.length:0;this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=s||0,this.endKnot=r||o;for(let e=0;e<i;++e){const t=n[e];this.controlPoints[e]=new Me(t.x,t.y,t.z,t.w)}}getPoint(e,t=new Re){const n=t,s=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=function(e,t,n,s){const r=Ft(e,s,t),o=Ut(r,s,e,t),i=new Me(0,0,0,0);for(let t=0;t<=e;++t){const s=n[r-e+t],a=o[t],c=s.w*a;i.x+=s.x*c,i.y+=s.y*c,i.z+=s.z*c,i.w+=s.w*a}return i}(this.degree,this.knots,this.controlPoints,s);return 1!==r.w&&r.divideScalar(r.w),n.set(r.x,r.y,r.z)}getTangent(e,t=new Re){const n=t,s=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=Ht(this.degree,this.knots,this.controlPoints,s,1);return n.copy(r[1]).normalize(),n}toJSON(){const e=super.toJSON();return e.degree=this.degree,e.knots=[...this.knots],e.controlPoints=this.controlPoints.map(e=>e.toArray()),e.startKnot=this.startKnot,e.endKnot=this.endKnot,e}fromJSON(e){return super.fromJSON(e),this.degree=e.degree,this.knots=[...e.knots],this.controlPoints=e.controlPoints.map(e=>new Me(e[0],e[1],e[2],e[3])),this.startKnot=e.startKnot,this.endKnot=e.endKnot,this}}let Vt,Gt,zt;class Kt extends F{constructor(e){super(e)}load(e,t,n,s){const r=this,o=""===r.path?U.extractUrlBase(e):r.path,i=new v(this.manager);i.setPath(r.path),i.setResponseType("arraybuffer"),i.setRequestHeader(r.requestHeader),i.setWithCredentials(r.withCredentials),i.load(e,function(n){try{t(r.parse(n,o))}catch(t){s&&s(t),r.manager.itemError(e)}},n,s)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===ln(e,0,t.length)}(e))Vt=(new $t).parse(e);else{const t=ln(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function s(t){const s=e[t-1];return e=e.slice(n+t),n++,s}for(let e=0;e<t.length;++e){if(s(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(Qt(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Qt(t));Vt=(new Yt).parse(t)}const n=new Te(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Xt(n,this.manager).parse(Vt)}}class Xt{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Gt=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),s=this.parseDeformers(),r=(new Wt).parse(s);return this.parseScene(s,r,n),zt}parseConnections(){const e=new Map;if("Connections"in Vt){Vt.Connections.connections.forEach(function(t){const n=t[0],s=t[1],r=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const o={ID:s,relationship:r};e.get(n).parents.push(o),e.has(s)||e.set(s,{parents:[],children:[]});const i={ID:n,relationship:r};e.get(s).children.push(i)})}return e}parseImages(){const e={},t={};if("Video"in Vt.Objects){const n=Vt.Objects.Video;for(const s in n){const r=n[s];if(e[parseInt(s)]=r.RelativeFilename||r.Filename,"Content"in r){const e=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,o="string"==typeof r.Content&&""!==r.Content;if(e||o){const e=this.parseImage(n[s]);t[r.RelativeFilename||r.Filename]=e}}}}for(const n in e){const s=e[n];void 0!==t[s]?e[n]=t[s]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename;let s;switch(n.slice(n.lastIndexOf(".")+1).toLowerCase()){case"bmp":s="image/bmp";break;case"jpg":case"jpeg":s="image/jpeg";break;case"png":s="image/png";break;case"tif":s="image/tiff";break;case"tga":this.manager.getHandler(".tga"),s="image/tga";break;case"webp":s="image/webp";break;default:return}if("string"==typeof t)return"data:"+s+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:s}))}}parseTextures(e){const t=new Map;if("Texture"in Vt.Objects){const n=Vt.Objects.Texture;for(const s in n){const r=this.parseTexture(n[s],e);t.set(parseInt(s),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const s=e.WrapModeU,r=e.WrapModeV,o=void 0!==s?s.value:0,i=void 0!==r?r.value:0;if(n.wrapS=0===o?ue:l,n.wrapT=0===i?ue:l,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;n.offset.x=t[0],n.offset.y=t[1]}return n}loadTexture(e,t){const n=e.FileName.split(".").pop().toLowerCase();let s=this.manager.getHandler(`.${n}`);null===s&&(s=this.textureLoader);const r=s.path;r||s.setPath(this.textureLoader.path);const o=Gt.get(e.id).children;let i;if(void 0!==o&&o.length>0&&void 0!==t[o[0].ID]&&(i=t[o[0].ID],0!==i.indexOf("blob:")&&0!==i.indexOf("data:")||s.setPath(void 0)),void 0===i)return new ye;const a=s.load(i);return s.setPath(r),a}parseMaterials(e){const t=new Map;if("Material"in Vt.Objects){const n=Vt.Objects.Material;for(const s in n){const r=this.parseMaterial(n[s],e);null!==r&&t.set(parseInt(s),r)}}return t}parseMaterial(e,t){const n=e.id,s=e.attrName;let r=e.ShadingModel;if("object"==typeof r&&(r=r.value),!Gt.has(n))return null;const o=this.parseParameters(e,t,n);let i;switch(r.toLowerCase()){case"phong":default:i=new X;break;case"lambert":i=new K}return i.setValues(o),i.name=s,i}parseParameters(e,t,n){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=h.colorSpaceToWorking((new u).fromArray(e.Diffuse.value),he):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(s.color=h.colorSpaceToWorking((new u).fromArray(e.DiffuseColor.value),he)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=h.colorSpaceToWorking((new u).fromArray(e.Emissive.value),he):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(s.emissive=h.colorSpaceToWorking((new u).fromArray(e.EmissiveColor.value),he)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),s.opacity=1-(e.TransparencyFactor?parseFloat(e.TransparencyFactor.value):0),1!==s.opacity&&0!==s.opacity||(s.opacity=e.Opacity?parseFloat(e.Opacity.value):null,null===s.opacity&&(s.opacity=1-(e.TransparentColor?parseFloat(e.TransparentColor.value[0]):0))),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=h.colorSpaceToWorking((new u).fromArray(e.Specular.value),he):e.SpecularColor&&"Color"===e.SpecularColor.type&&(s.specular=h.colorSpaceToWorking((new u).fromArray(e.SpecularColor.value),he));const r=this;return Gt.get(n).children.forEach(function(e){switch(e.relationship){case"Bump":s.bumpMap=r.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":s.aoMap=r.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=r.getTexture(t,e.ID),void 0!==s.map&&(s.map.colorSpace=he);break;case"DisplacementColor":s.displacementMap=r.getTexture(t,e.ID);break;case"EmissiveColor":s.emissiveMap=r.getTexture(t,e.ID),void 0!==s.emissiveMap&&(s.emissiveMap.colorSpace=he);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=r.getTexture(t,e.ID);break;case"ReflectionColor":s.envMap=r.getTexture(t,e.ID),void 0!==s.envMap&&(s.envMap.mapping=m,s.envMap.colorSpace=he);break;case"SpecularColor":s.specularMap=r.getTexture(t,e.ID),void 0!==s.specularMap&&(s.specularMap.colorSpace=he);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=r.getTexture(t,e.ID),s.transparent=!0}}),s}getTexture(e,t){return"LayeredTexture"in Vt.Objects&&t in Vt.Objects.LayeredTexture&&(t=Gt.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Vt.Objects){const n=Vt.Objects.Deformer;for(const s in n){const r=n[s],o=Gt.get(parseInt(s));if("Skin"===r.attrType){const t=this.parseSkeleton(o,n);t.ID=s,o.parents.length,t.geometryID=o.parents[0].ID,e[s]=t}else if("BlendShape"===r.attrType){const e={id:s};e.rawTargets=this.parseMorphTargets(o,n),e.id=s,o.parents.length,t[s]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach(function(e){const s=t[e.ID];if("Cluster"!==s.attrType)return;const r={ID:e.ID,indices:[],weights:[],transformLink:(new V).fromArray(s.TransformLink.a)};"Indexes"in s&&(r.indices=s.Indexes.a,r.weights=s.Weights.a),n.push(r)}),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let s=0;s<e.children.length;s++){const r=e.children[s],o=t[r.ID],i={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if("BlendShapeChannel"!==o.attrType)return;i.geoID=Gt.get(parseInt(r.ID)).children.filter(function(e){return void 0===e.relationship})[0].ID,n.push(i)}return n}parseScene(e,t,n){zt=new x;const s=this.parseModels(e.skeletons,t,n),r=Vt.Objects.Model,o=this;s.forEach(function(e){const t=r[e.ID];o.setLookAtProperties(e,t);Gt.get(e.ID).parents.forEach(function(t){const n=s.get(t.ID);void 0!==n&&n.add(e)}),null===e.parent&&zt.add(e)}),this.bindSkeleton(e.skeletons,t,s),this.addGlobalSceneSettings(),zt.traverse(function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=on(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}});const i=(new qt).parse();1===zt.children.length&&zt.children[0].isGroup&&(zt.children[0].animations=i,zt=zt.children[0]),zt.animations=i}parseModels(e,t,n){const s=new Map,r=Vt.Objects.Model;for(const i in r){const a=parseInt(i),c=r[i],l=Gt.get(a);let u=this.buildSkeleton(l,e,a,c.attrName);if(!u){switch(c.attrType){case"Camera":u=this.createCamera(l);break;case"Light":u=this.createLight(l);break;case"Mesh":u=this.createMesh(l,t,n);break;case"NurbsCurve":u=this.createCurve(l,t);break;case"LimbNode":case"Root":u=new o;break;default:u=new x}u.name=c.attrName?ae.sanitizeNodeName(c.attrName):"",u.userData.originalName=c.attrName,u.ID=a}this.getTransformData(u,c),s.set(a,u)}return s}buildSkeleton(e,t,n,s){let r=null;return e.parents.forEach(function(e){for(const i in t){const a=t[i];a.rawBones.forEach(function(t,i){if(t.ID===e.ID){const e=r;r=new o,r.matrixWorld.copy(t.transformLink),r.name=s?ae.sanitizeNodeName(s):"",r.userData.originalName=s,r.ID=n,a.bones[i]=r,null!==e&&r.add(e)}})}}),r}createCamera(e){let t,n;if(e.children.forEach(function(e){const t=Vt.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)}),void 0===n)t=new ee;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let s=1;void 0!==n.NearPlane&&(s=n.NearPlane.value/1e3);let r=1e3;void 0!==n.FarPlane&&(r=n.FarPlane.value/1e3);let o=window.innerWidth,i=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(o=n.AspectWidth.value,i=n.AspectHeight.value);const a=o/i;let c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);const l=n.FocalLength?n.FocalLength.value:null;if(0===e)t=new ne(c,a,s,r),null!==l&&t.setFocalLength(l);else t=new ee}return t}createLight(e){let t,n;if(e.children.forEach(function(e){const t=Vt.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)}),void 0===n)t=new ee;else{let e;e=void 0===n.LightType?0:n.LightType.value;let s=16777215;void 0!==n.Color&&(s=h.colorSpaceToWorking((new u).fromArray(n.Color.value),he));let r=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(r=0);let o=0;void 0!==n.FarAttenuationEnd&&(o=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const i=1;switch(e){case 0:t=new se(s,r,o,i);break;case 1:t=new d(s,r);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=H.degToRad(n.InnerAngle.value));let a=0;void 0!==n.OuterAngle&&(a=H.degToRad(n.OuterAngle.value),a=Math.max(a,1)),t=new ve(s,r,o,e,a,i);break;default:t=new se(s,r)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let s,r=null,o=null;const i=[];if(e.children.forEach(function(e){t.has(e.ID)&&(r=t.get(e.ID)),n.has(e.ID)&&i.push(n.get(e.ID))}),i.length>1?o=i:i.length>0?o=i[0]:(o=new X({name:F.DEFAULT_MATERIAL_NAME,color:13421772}),i.push(o)),"color"in r.attributes&&i.forEach(function(e){e.vertexColors=!0}),r.groups.length>0){let e=!1;for(let t=0,n=r.groups.length;t<n;t++){const n=r.groups[t];(n.materialIndex<0||n.materialIndex>=i.length)&&(n.materialIndex=i.length,e=!0)}if(e){const e=new X;i.push(e)}}return r.FBX_Deformer?(s=new fe(r,o),s.normalizeSkinWeights()):s=new G(r,o),s}createCurve(e,t){const n=e.children.reduce(function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e},null),s=new N({name:F.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new _(n,s)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder=an("RotationOrder"in t?t.RotationOrder.value:0),"Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){if("LookAtProperty"in t){Gt.get(e.ID).children.forEach(function(t){if("LookAtProperty"===t.relationship){const n=Vt.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),zt.add(e.target)):e.lookAt((new Re).fromArray(t))}}})}}bindSkeleton(e,t,n){const s=this.parsePoseNodes();for(const r in e){const o=e[r];Gt.get(parseInt(o.ID)).parents.forEach(function(e){if(t.has(e.ID)){const t=e.ID;Gt.get(t).parents.forEach(function(e){if(n.has(e.ID)){n.get(e.ID).bind(new de(o.bones),s[e.ID])}})}})}}parsePoseNodes(){const e={};if("Pose"in Vt.Objects){const t=Vt.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const s=t[n].PoseNode;Array.isArray(s)?s.forEach(function(t){e[t.Node]=(new V).fromArray(t.Matrix.a)}):e[s.Node]=(new V).fromArray(s.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in Vt){if("AmbientColor"in Vt.GlobalSettings){const t=Vt.GlobalSettings.AmbientColor.value,n=t[0],s=t[1],r=t[2];if(0!==n||0!==s||0!==r){const t=(new u).setRGB(n,s,r,he);zt.add(new e(t,1))}}"UnitScaleFactor"in Vt.GlobalSettings&&(zt.userData.unitScaleFactor=Vt.GlobalSettings.UnitScaleFactor.value)}}}class Wt{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in Vt.Objects){const n=Vt.Objects.Geometry;for(const s in n){const r=Gt.get(parseInt(s)),o=this.parseGeometry(r,n[s],e);t.set(parseInt(s),o)}}return this.negativeMaterialIndices,t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const s=n.skeletons,r=[],o=e.parents.map(function(e){return Vt.Objects.Model[e.ID]});if(0===o.length)return;const i=e.children.reduce(function(e,t){return void 0!==s[t.ID]&&(e=s[t.ID]),e},null);e.children.forEach(function(e){void 0!==n.morphTargets[e.ID]&&r.push(n.morphTargets[e.ID])});const a=o[0],c={};"RotationOrder"in a&&(c.eulerOrder=an(a.RotationOrder.value)),"InheritType"in a&&(c.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(c.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(c.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(c.scale=a.GeometricScaling.value);const l=on(c);return this.genGeometry(t,i,r,l)}genGeometry(e,t,n,s){const r=new c;e.attrName&&(r.name=e.attrName);const o=this.parseGeoNode(e,t),i=this.genBuffers(o),a=new y(i.vertex,3);if(a.applyMatrix4(s),r.setAttribute("position",a),i.colors.length>0&&r.setAttribute("color",new y(i.colors,3)),t&&(r.setAttribute("skinIndex",new be(i.weightsIndices,4)),r.setAttribute("skinWeight",new y(i.vertexWeights,4)),r.FBX_Deformer=t),i.normal.length>0){const e=(new B).getNormalMatrix(s),t=new y(i.normal,3);t.applyNormalMatrix(e),r.setAttribute("normal",t)}if(i.uvs.forEach(function(e,t){const n=0===t?"uv":`uv${t}`;r.setAttribute(n,new y(i.uvs[t],2))}),o.material&&"AllSame"!==o.material.mappingType){let e=i.materialIndex[0],t=0;if(i.materialIndex.forEach(function(n,s){n!==e&&(r.addGroup(t,s-t,e),e=n,t=s)}),r.groups.length>0){const t=r.groups[r.groups.length-1],n=t.start+t.count;n!==i.materialIndex.length&&r.addGroup(n,i.materialIndex.length-n,e)}0===r.groups.length&&r.addGroup(0,i.materialIndex.length,i.materialIndex[0])}return this.addMorphTargets(r,e,n,s),r}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach(function(e,t){e.indices.forEach(function(s,r){void 0===n.weightTable[s]&&(n.weightTable[s]=[]),n.weightTable[s].push({id:t,weight:e.weights[r]})})})),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,s=0,r=!1,o=[],i=[],a=[],c=[],l=[],u=[];const h=this;return e.vertexIndices.forEach(function(p,d){let f,m=!1;p<0&&(p^=-1,m=!0);let g=[],v=[];if(o.push(3*p,3*p+1,3*p+2),e.color){const t=nn(d,n,p,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[p]&&e.weightTable[p].forEach(function(e){v.push(e.weight),g.push(e.id)}),v.length>4){r||(r=!0);const e=[0,0,0,0],t=[0,0,0,0];v.forEach(function(n,s){let r=n,o=g[s];t.forEach(function(t,n,s){if(r>t){s[n]=r,r=t;const i=e[n];e[n]=o,o=i}})}),g=e,v=t}for(;v.length<4;)v.push(0),g.push(0);for(let e=0;e<4;++e)l.push(v[e]),u.push(g[e])}if(e.normal){const t=nn(d,n,p,e.normal);i.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(f=nn(d,n,p,e.material)[0],f<0&&(h.negativeMaterialIndices=!0,f=0)),e.uv&&e.uv.forEach(function(e,t){const s=nn(d,n,p,e);void 0===c[t]&&(c[t]=[]),c[t].push(s[0]),c[t].push(s[1])}),s++,m&&(h.genFace(t,e,o,f,i,a,c,l,u,s),n++,s=0,o=[],i=[],a=[],c=[],l=[],u=[])}),t}getNormalNewell(e){const t=new Re(0,0,0);for(let n=0;n<e.length;n++){const s=e[n],r=e[(n+1)%e.length];t.x+=(s.y-r.y)*(s.z+r.z),t.y+=(s.z-r.z)*(s.x+r.x),t.z+=(s.x-r.x)*(s.y+r.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),n=(Math.abs(t.z)>.5?new Re(0,1,0):new Re(0,0,1)).cross(t).normalize(),s=t.clone().cross(n).normalize();return{normal:t,tangent:n,bitangent:s}}flattenVertex(e,t,n){return new Ie(e.dot(t),e.dot(n))}genFace(e,t,n,s,r,o,i,a,c,l){let u;if(l>3){const e=[],s=t.baseVertexPositions||t.vertexPositions;for(let t=0;t<n.length;t+=3)e.push(new Re(s[n[t]],s[n[t+1]],s[n[t+2]]));const{tangent:r,bitangent:o}=this.getNormalTangentAndBitangent(e),i=[];for(const t of e)i.push(this.flattenVertex(t,r,o));u=pe.triangulateShape(i,[])}else u=[[0,1,2]];for(const[l,h,p]of u)e.vertex.push(t.vertexPositions[n[3*l]]),e.vertex.push(t.vertexPositions[n[3*l+1]]),e.vertex.push(t.vertexPositions[n[3*l+2]]),e.vertex.push(t.vertexPositions[n[3*h]]),e.vertex.push(t.vertexPositions[n[3*h+1]]),e.vertex.push(t.vertexPositions[n[3*h+2]]),e.vertex.push(t.vertexPositions[n[3*p]]),e.vertex.push(t.vertexPositions[n[3*p+1]]),e.vertex.push(t.vertexPositions[n[3*p+2]]),t.skeleton&&(e.vertexWeights.push(a[4*l]),e.vertexWeights.push(a[4*l+1]),e.vertexWeights.push(a[4*l+2]),e.vertexWeights.push(a[4*l+3]),e.vertexWeights.push(a[4*h]),e.vertexWeights.push(a[4*h+1]),e.vertexWeights.push(a[4*h+2]),e.vertexWeights.push(a[4*h+3]),e.vertexWeights.push(a[4*p]),e.vertexWeights.push(a[4*p+1]),e.vertexWeights.push(a[4*p+2]),e.vertexWeights.push(a[4*p+3]),e.weightsIndices.push(c[4*l]),e.weightsIndices.push(c[4*l+1]),e.weightsIndices.push(c[4*l+2]),e.weightsIndices.push(c[4*l+3]),e.weightsIndices.push(c[4*h]),e.weightsIndices.push(c[4*h+1]),e.weightsIndices.push(c[4*h+2]),e.weightsIndices.push(c[4*h+3]),e.weightsIndices.push(c[4*p]),e.weightsIndices.push(c[4*p+1]),e.weightsIndices.push(c[4*p+2]),e.weightsIndices.push(c[4*p+3])),t.color&&(e.colors.push(o[3*l]),e.colors.push(o[3*l+1]),e.colors.push(o[3*l+2]),e.colors.push(o[3*h]),e.colors.push(o[3*h+1]),e.colors.push(o[3*h+2]),e.colors.push(o[3*p]),e.colors.push(o[3*p+1]),e.colors.push(o[3*p+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(r[3*l]),e.normal.push(r[3*l+1]),e.normal.push(r[3*l+2]),e.normal.push(r[3*h]),e.normal.push(r[3*h+1]),e.normal.push(r[3*h+2]),e.normal.push(r[3*p]),e.normal.push(r[3*p+1]),e.normal.push(r[3*p+2])),t.uv&&t.uv.forEach(function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(i[n][2*l]),e.uvs[n].push(i[n][2*l+1]),e.uvs[n].push(i[n][2*h]),e.uvs[n].push(i[n][2*h+1]),e.uvs[n].push(i[n][2*p]),e.uvs[n].push(i[n][2*p+1])})}addMorphTargets(e,t,n,s){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach(function(n){n.rawTargets.forEach(function(n){const o=Vt.Objects.Geometry[n.geoID];void 0!==o&&r.genMorphGeometry(e,t,o,s,n.name)})})}genMorphGeometry(e,t,n,s,r){const o=void 0!==t.Vertices?t.Vertices.a:[],i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],a=void 0!==n.Vertices?n.Vertices.a:[],c=void 0!==n.Indexes?n.Indexes.a:[],l=3*e.attributes.position.count,u=new Float32Array(l);for(let e=0;e<c.length;e++){const t=3*c[e];u[t]=a[3*e],u[t+1]=a[3*e+1],u[t+2]=a[3*e+2]}const h={vertexIndices:i,vertexPositions:u,baseVertexPositions:o},p=this.genBuffers(h),d=new y(p.vertex,3);d.name=r||n.attrName,d.applyMatrix4(s),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Normals.a;let r=[];return"IndexToDirect"===n&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.UV.a;let r=[];return"IndexToDirect"===n&&(r=e.UVIndex.a),{dataSize:2,buffer:s,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Colors.a;let r=[];"IndexToDirect"===n&&(r=e.ColorIndex.a);for(let e=0,t=new u;e<s.length;e+=4)t.fromArray(s,e),h.colorSpaceToWorking(t,he),t.toArray(s,e);return{dataSize:4,buffer:s,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const s=e.Materials.a,r=[];for(let e=0;e<s.length;++e)r.push(e);return{dataSize:1,buffer:s,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return new c;const n=t-1,s=e.KnotVector.a,r=[],o=e.Points.a;for(let e=0,t=o.length;e<t;e+=4)r.push((new Me).fromArray(o,e));let i,a;if("Closed"===e.Form)r.push(r[0]);else if("Periodic"===e.Form){i=n,a=s.length-1-i;for(let e=0;e<n;++e)r.push(r[e])}const l=new Bt(n,s,r,i,a).getPoints(12*r.length);return(new c).setFromPoints(l)}}class qt{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const s=t[n],r=this.addClip(s);e.push(r)}return e}parseClips(){if(void 0===Vt.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Vt.Objects.AnimationCurveNode,t=new Map;for(const n in e){const s=e[n];if(null!==s.attrName.match(/S|R|T|DeformPercent/)){const e={id:s.id,attr:s.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Vt.Objects.AnimationCurve;for(const n in t){const s={id:t[n].id,times:t[n].KeyTime.a.map(en),values:t[n].KeyValueFloat.a},r=Gt.get(s.id);if(void 0!==r){const t=r.parents[0].ID,n=r.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=s:n.match(/Y/)?e.get(t).curves.y=s:n.match(/Z/)?e.get(t).curves.z=s:n.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=s)}}}parseAnimationLayers(e){const t=Vt.Objects.AnimationLayer,n=new Map;for(const s in t){const t=[],r=Gt.get(parseInt(s));if(void 0!==r){r.children.forEach(function(n,s){if(e.has(n.ID)){const r=e.get(n.ID);if(void 0!==r.curves.x||void 0!==r.curves.y||void 0!==r.curves.z){if(void 0===t[s]){const e=Gt.get(n.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID;if(void 0!==e){const n=Vt.Objects.Model[e.toString()];if(void 0===n)return;const r={modelName:n.attrName?ae.sanitizeNodeName(n.attrName):"",ID:n.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};zt.traverse(function(e){e.ID===n.id&&(r.transform=e.matrix,e.userData.transformData&&(r.eulerOrder=e.userData.transformData.eulerOrder))}),r.transform||(r.transform=new V),"PreRotation"in n&&(r.preRotation=n.PreRotation.value),"PostRotation"in n&&(r.postRotation=n.PostRotation.value),t[s]=r}}t[s]&&(t[s][r.attr]=r)}else if(void 0!==r.curves.morph){if(void 0===t[s]){const e=Gt.get(n.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID,r=Gt.get(e).parents[0].ID,o=Gt.get(r).parents[0].ID,i=Gt.get(o).parents[0].ID,a=Vt.Objects.Model[i],c={modelName:a.attrName?ae.sanitizeNodeName(a.attrName):"",morphName:Vt.Objects.Deformer[e].attrName};t[s]=c}t[s][r.attr]=r}}}),n.set(parseInt(s),t)}}return n}parseAnimStacks(e){const t=Vt.Objects.AnimationStack,n={};for(const s in t){const r=Gt.get(parseInt(s)).children;r.length;const o=e.get(r[0].ID);n[s]={name:t[s].attrName,layer:o}}return n}addClip(e){let n=[];const s=this;return e.layer.forEach(function(e){n=n.concat(s.generateTracks(e))}),new t(e.name,-1,n)}generateTracks(e){const t=[];let n=new Re,s=new Re;if(e.transform&&e.transform.decompose(n,new ce,s),n=n.toArray(),s=s.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const s=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==s&&t.push(s)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,s){const r=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(r,t,n);return new Se(e+"."+s,r,o)}generateRotationTrack(e,t,n,s,r){let o,i;if(void 0!==t.x&&void 0!==t.y&&void 0!==t.z){const e=this.interpolateRotations(t.x,t.y,t.z,r);o=e[0],i=e[1]}const a=an(0);void 0!==n&&((n=n.map(H.degToRad)).push(a),n=(new g).fromArray(n),n=(new ce).setFromEuler(n)),void 0!==s&&((s=s.map(H.degToRad)).push(a),s=(new g).fromArray(s),s=(new ce).setFromEuler(s).invert());const c=new ce,l=new g,u=[];if(!i||!o)return new le(e+".quaternion",[0],[0]);for(let e=0;e<i.length;e+=3){if(l.set(i[e],i[e+1],i[e+2],r),c.setFromEuler(l),void 0!==n&&c.premultiply(n),void 0!==s&&c.multiply(s),e>2){(new ce).fromArray(u,(e-3)/3*4).dot(c)<0&&c.set(-c.x,-c.y,-c.z,-c.w)}c.toArray(u,e/3*4)}return new le(e+".quaternion",o,u)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map(function(e){return e/100}),s=zt.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Q(e.modelName+".morphTargetInfluences["+s+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort(function(e,t){return e-t}),t.length>1){let e=1,n=t[0];for(let s=1;s<t.length;s++){const r=t[s];r!==n&&(t[e]=r,n=r,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const s=n,r=[];let o=-1,i=-1,a=-1;return e.forEach(function(e){if(t.x&&(o=t.x.times.indexOf(e)),t.y&&(i=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==o){const e=t.x.values[o];r.push(e),s[0]=e}else r.push(s[0]);if(-1!==i){const e=t.y.values[i];r.push(e),s[1]=e}else r.push(s[1]);if(-1!==a){const e=t.z.values[a];r.push(e),s[2]=e}else r.push(s[2])}),r}interpolateRotations(e,t,n,s){const r=[],o=[];r.push(e.times[0]),o.push(H.degToRad(e.values[0])),o.push(H.degToRad(t.values[0])),o.push(H.degToRad(n.values[0]));for(let i=1;i<e.values.length;i++){const a=[e.values[i-1],t.values[i-1],n.values[i-1]];if(isNaN(a[0])||isNaN(a[1])||isNaN(a[2]))continue;const c=a.map(H.degToRad),l=[e.values[i],t.values[i],n.values[i]];if(isNaN(l[0])||isNaN(l[1])||isNaN(l[2]))continue;const u=l.map(H.degToRad),h=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],p=[Math.abs(h[0]),Math.abs(h[1]),Math.abs(h[2])];if(p[0]>=180||p[1]>=180||p[2]>=180){const t=Math.max(...p)/180,n=new g(...c,s),a=new g(...u,s),l=(new ce).setFromEuler(n),h=(new ce).setFromEuler(a);l.dot(h)&&h.set(-h.x,-h.y,-h.z,-h.w);const d=e.times[i-1],f=e.times[i]-d,m=new ce,v=new g;for(let e=0;e<1;e+=1/t)m.copy(l.clone().slerp(h.clone(),e)),r.push(d+e*f),v.setFromQuaternion(m,s),o.push(v.x),o.push(v.y),o.push(v.z)}else r.push(e.times[i]),o.push(H.degToRad(e.values[i])),o.push(H.degToRad(t.values[i])),o.push(H.degToRad(n.values[i]))}return[r,o]}}class Yt{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new Jt,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach(function(e,s){const r=e.match(/^[\s\t]*;/),o=e.match(/^[\s\t]*$/);if(r||o)return;const i=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),c=e.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(e,i):a?t.parseNodeProperty(e,a,n[++s]):c?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),r={name:n},o=this.parseNodeAttr(s),i=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,r):n in i?("PoseNode"===n?i.PoseNode.push(r):void 0!==i[n].id&&(i[n]={},i[n][i[n].id]=i[n]),""!==o.id&&(i[n][o.id]=r)):"number"==typeof o.id?(i[n]={},i[n][o.id]=r):"Properties70"!==n&&(i[n]="PoseNode"===n?[r]:r),"number"==typeof o.id&&(r.id=o.id),""!==o.name&&(r.attrName=o.name),""!==o.type&&(r.attrType=o.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",s="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:n,type:s}}parseNodeProperty(e,t,n){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===s&&","===r&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if("Properties70"!==o.name){if("C"===s){const e=r.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let i=r.split(",").slice(3);i=i.map(function(e){return e.trim().replace(/^"/,"")}),s="connections",r=[t,n],function(e,t){for(let n=0,s=e.length,r=t.length;n<r;n++,s++)e[s]=t[n]}(r,i),void 0===o[s]&&(o[s]=[])}"Node"===s&&(o.id=r),s in o&&Array.isArray(o[s])?o[s].push(r):"a"!==s?o[s]=r:o.a=r,this.setCurrentProp(o,s),"a"===s&&","!==r.slice(-1)&&(o.a=cn(r))}else this.parseNodeSpecialProperty(e,s,r)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=cn(t.a))}parseNodeSpecialProperty(e,t,n){const s=n.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),r=s[0],o=s[1],i=s[2],a=s[3];let c=s[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=cn(c)}this.getPrevNode()[r]={type:o,type2:i,flag:a,value:c},this.setCurrentProp(this.getPrevNode(),r)}}class $t{parse(e){const t=new Zt(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const s=new Jt;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&s.add(e.name,e)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},s=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),i=e.getString(o);if(0===s)return null;const a=[];for(let t=0;t<r;t++)a.push(this.parseProperty(e));const c=a.length>0?a[0]:"",l=a.length>1?a[1]:"",u=a.length>2?a[2]:"";for(n.singleProperty=1===r&&e.getOffset()===s;s>e.getOffset();){const s=this.parseNode(e,t);null!==s&&this.parseSubNode(i,n,s)}return n.propertyList=a,"number"==typeof c&&(n.id=c),""!==l&&(n.attrName=l),""!==u&&(n.attrType=u),""!==i&&(n.name=i),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach(function(t,n){0!==n&&e.push(t)}),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach(function(e){t[e]=n[e]})}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],s=n.propertyList[1];const r=n.propertyList[2],o=n.propertyList[3];let i;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),i="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:s,type2:r,flag:o,value:i}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),r=e.getUint32(),o=e.getUint32();if(0===r)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}const i=kt(new Uint8Array(e.getArrayBuffer(o))),a=new Zt(i.buffer);switch(t){case"b":case"c":return a.getBooleanArray(s);case"d":return a.getFloat64Array(s);case"f":return a.getFloat32Array(s);case"i":return a.getInt32Array(s);case"l":return a.getInt64Array(s)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Zt{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const s=n.indexOf(0);return s>=0&&(n=new Uint8Array(this.dv.buffer,t,s)),this._textDecoder.decode(n)}}class Jt{add(e,t){this[e]=t}}function Qt(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function en(e){return e/46186158e3}const tn=[];function nn(e,t,n,s){let r;switch(s.mappingType){case"ByPolygonVertex":r=e;break;case"ByPolygon":r=t;break;case"ByVertice":r=n;break;case"AllSame":r=s.indices[0]}"IndexToDirect"===s.referenceType&&(r=s.indices[r]);const o=r*s.dataSize,i=o+s.dataSize;return function(e,t,n,s){for(let r=n,o=0;r<s;r++,o++)e[o]=t[r];return e}(tn,s.buffer,o,i)}const sn=new g,rn=new Re;function on(e){const t=new V,n=new V,s=new V,r=new V,o=new V,i=new V,a=new V,c=new V,l=new V,u=new V,h=new V,p=new V,d=e.inheritType?e.inheritType:0;e.translation&&t.setPosition(rn.fromArray(e.translation));const f=an(0);if(e.preRotation){const t=e.preRotation.map(H.degToRad);t.push(f),n.makeRotationFromEuler(sn.fromArray(t))}if(e.rotation){const t=e.rotation.map(H.degToRad);t.push(e.eulerOrder||f),s.makeRotationFromEuler(sn.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(H.degToRad);t.push(f),r.makeRotationFromEuler(sn.fromArray(t)),r.invert()}e.scale&&o.scale(rn.fromArray(e.scale)),e.scalingOffset&&a.setPosition(rn.fromArray(e.scalingOffset)),e.scalingPivot&&i.setPosition(rn.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(rn.fromArray(e.rotationOffset)),e.rotationPivot&&l.setPosition(rn.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(h.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const m=n.clone().multiply(s).multiply(r),g=new V;g.extractRotation(u);const v=new V;v.copyPosition(u);const y=v.clone().invert().multiply(u),T=g.clone().invert().multiply(y),x=o,w=new V;if(0===d)w.copy(g).multiply(m).multiply(T).multiply(x);else if(1===d)w.copy(g).multiply(T).multiply(m).multiply(x);else{const e=(new V).scale((new Re).setFromMatrixScale(h)).clone().invert(),t=T.clone().multiply(e);w.copy(g).multiply(m).multiply(t).multiply(x)}const A=l.clone().invert(),b=i.clone().invert();let I=t.clone().multiply(c).multiply(l).multiply(n).multiply(s).multiply(r).multiply(A).multiply(a).multiply(i).multiply(o).multiply(b);const R=(new V).copyPosition(I),M=u.clone().multiply(R);return p.copyPosition(M),I=p.clone().multiply(w),I.premultiply(u.invert()),I}function an(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?t[0]:t[e]}function cn(e){return e.split(",").map(function(e){return parseFloat(e)})}function ln(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,n))}function un(e,t){if(t===Ae)return e;if(t===xe||t===we){let n=e.getIndex();if(null===n){const t=[],s=e.getAttribute("position");if(void 0===s)return e;for(let e=0;e<s.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const s=n.count-2,r=[];if(t===xe)for(let e=1;e<=s;e++)r.push(n.getX(0)),r.push(n.getX(e)),r.push(n.getX(e+1));else for(let e=0;e<s;e++)e%2==0?(r.push(n.getX(e)),r.push(n.getX(e+1)),r.push(n.getX(e+2))):(r.push(n.getX(e+2)),r.push(n.getX(e+1)),r.push(n.getX(e)));r.length;const o=e.clone();return o.setIndex(r),o.clearGroups(),o}return e}function hn(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const pn={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class dn{constructor(e){this.parser=e,this.name=pn.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,s=t.length;n<s;n++){const s=t[n];s.extensions&&s.extensions[this.name]&&void 0!==s.extensions[this.name].light&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let s=t.cache.get(n);if(s)return s;const r=t.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let i;const a=new u(16777215);void 0!==o.color&&a.setRGB(o.color[0],o.color[1],o.color[2],D);const c=void 0!==o.range?o.range:0;switch(o.type){case"directional":i=new d(a),i.target.position.set(0,0,-1),i.add(i.target);break;case"point":i=new se(a),i.distance=c;break;case"spot":i=new ve(a),i.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,i.angle=o.spot.outerConeAngle,i.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return i.position.set(0,0,0),es(i,o),void 0!==o.intensity&&(i.intensity=o.intensity),i.name=t.createUniqueName(o.name||"light_"+e),s=Promise.resolve(i),t.cache.add(n,s),s}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,s=n.json.nodes[e],r=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then(function(e){return n._getNodeRef(t.cache,r,e)})}}class fn{constructor(){this.name=pn.KHR_MATERIALS_UNLIT}getMaterialType(){return z}extendParams(e,t,n){const s=[];e.color=new u(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],D),e.opacity=t[3]}void 0!==r.baseColorTexture&&s.push(n.assignTexture(e,"map",r.baseColorTexture,he))}return Promise.all(s)}}class mn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name].emissiveStrength;return void 0!==s&&(t.emissiveIntensity=s),Promise.resolve()}}class gn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Ie(e,e)}return Promise.all(r)}}class vn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.dispersion=void 0!==s.dispersion?s.dispersion:0,Promise.resolve()}}class yn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&r.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&r.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Tn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new u(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=s.extensions[this.name];if(void 0!==o.sheenColorFactor){const e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],D)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&r.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,he)),void 0!==o.sheenRoughnessTexture&&r.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class xn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class wn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&r.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const i=o.attenuationColor||[1,1,1];return t.attenuationColor=(new u).setRGB(i[0],i[1],i[2],D),Promise.all(r)}}class An{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.ior=void 0!==s.ior?s.ior:1.5,Promise.resolve()}}class bn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&r.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));const i=o.specularColorFactor||[1,1,1];return t.specularColor=(new u).setRGB(i[0],i[1],i[2],D),void 0!==o.specularColorTexture&&r.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,he)),Promise.all(r)}}class In{constructor(e){this.parser=e,this.name=pn.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&r.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(r)}}class Rn{constructor(e){this.parser=e,this.name=pn.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&r.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class Mn{constructor(e){this.parser=e,this.name=pn.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,s=n.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const r=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class Sn{constructor(e){this.parser=e,this.name=pn.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,n=this.parser,s=n.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=s.images[o.source];let a=n.textureLoader;if(i.uri){const e=n.options.manager.getHandler(i.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class En{constructor(e){this.parser=e,this.name=pn.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,n=this.parser,s=n.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=s.images[o.source];let a=n.textureLoader;if(i.uri){const e=n.options.manager.getHandler(i.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class _n{constructor(e){this.name=pn.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],s=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then(function(t){const n=e.byteOffset||0,s=e.byteLength||0,o=e.count,i=e.byteStride,a=new Uint8Array(t,n,s);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(o,i,a,e.mode,e.filter).then(function(e){return e.buffer}):r.ready.then(function(){const t=new ArrayBuffer(o*i);return r.decodeGltfBuffer(new Uint8Array(t),o,i,a,e.mode,e.filter),t})})}return null}}class Nn{constructor(e){this.name=pn.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const s=t.meshes[n.mesh];for(const e of s.primitives)if(e.mode!==Bn.TRIANGLES&&e.mode!==Bn.TRIANGLE_STRIP&&e.mode!==Bn.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=n.extensions[this.name].attributes,o=[],i={};for(const e in r)o.push(this.parser.getDependency("accessor",r[e]).then(t=>(i[e]=t,i[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{const t=e.pop(),n=t.isGroup?t.children:[t],s=e[0].count,r=[];for(const e of n){const t=new V,n=new Re,o=new ce,a=new Re(1,1,1),c=new b(e.geometry,e.material,s);for(let e=0;e<s;e++)i.TRANSLATION&&n.fromBufferAttribute(i.TRANSLATION,e),i.ROTATION&&o.fromBufferAttribute(i.ROTATION,e),i.SCALE&&a.fromBufferAttribute(i.SCALE,e),c.setMatrixAt(e,t.compose(n,o,a));for(const t in i)if("_COLOR_0"===t){const e=i[t];c.instanceColor=new A(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,i[t]);ee.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),r.push(c)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]}))}}const Ln="glTF",Pn=1313821514,Cn=5130562;class On{constructor(e){this.name=pn.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Ln)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12,r=new DataView(e,12);let o=0;for(;o<s;){const t=r.getUint32(o,!0);o+=4;const s=r.getUint32(o,!0);if(o+=4,s===Pn){const s=new Uint8Array(e,12+o,t);this.content=n.decode(s)}else if(s===Cn){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class kn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=pn.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,s=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,i={},a={},c={};for(const e in o){const t=Xn[e]||e.toLowerCase();i[t]=o[e]}for(const t in e.attributes){const s=Xn[t]||t.toLowerCase();if(void 0!==o[t]){const r=n.accessors[e.attributes[t]],o=Vn[r.componentType];c[s]=o.name,a[s]=!0===r.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t,n){s.decodeDracoFile(e,function(e){for(const t in e.attributes){const n=e.attributes[t],s=a[t];void 0!==s&&(n.normalized=s)}t(e)},i,c,D,n)})})}}class Dn{constructor(){this.name=pn.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Fn{constructor(){this.name=pn.KHR_MESH_QUANTIZATION}}class Un extends M{constructor(e,t,n,s){super(e,t,n,s)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,s=this.valueSize,r=e*s*3+s;for(let e=0;e!==s;e++)t[e]=n[r+e];return t}interpolate_(e,t,n,s){const r=this.resultBuffer,o=this.sampleValues,i=this.valueSize,a=2*i,c=3*i,l=s-t,u=(n-t)/l,h=u*u,p=h*u,d=e*c,f=d-c,m=-2*p+3*h,g=p-h,v=1-m,y=g-h+u;for(let e=0;e!==i;e++){const t=o[f+e+i],n=o[f+e+a]*l,s=o[d+e+i],c=o[d+e]*l;r[e]=v*t+y*n+m*s+g*c}return r}}const jn=new ce;class Hn extends Un{interpolate_(e,t,n,s){const r=super.interpolate_(e,t,n,s);return jn.fromArray(r).normalize().toArray(r),r}}const Bn={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Vn={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Gn={9728:$,9729:C,9984:J,9985:k,9986:Z,9987:O},zn={33071:l,33648:Y,10497:ue},Kn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Xn={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Wn={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},qn={CUBICSPLINE:void 0,LINEAR:E,STEP:S},Yn="OPAQUE",$n="MASK",Zn="BLEND";function Jn(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new q({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:T})),e.DefaultMaterial}function Qn(e,t,n){for(const s in n.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=n.extensions[s])}function es(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function ts(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,s=t.weights.length;n<s;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,s=n.length;t<s;t++)e.morphTargetDictionary[n[t]]=t}}}function ns(e){let t;const n=e.extensions&&e.extensions[pn.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ss(n.attributes):e.indices+":"+ss(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,s=e.targets.length;n<s;n++)t+=":"+ss(e.targets[n]);return t}function ss(e){let t="";const n=Object.keys(e).sort();for(let s=0,r=n.length;s<r;s++)t+=n[s]+":"+e[n[s]]+";";return t}function rs(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const os=new V;class is{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new hn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,s=-1,r=!1,o=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);s=n&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,o=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||n&&s<17||r&&o<98?this.textureLoader=new Te(this.options.manager):this.textureLoader=new w(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new v(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,s=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){const o={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:n,userData:{}};return Qn(r,o,s),es(o,s),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(const e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let t=0,s=e.length;t<s;t++){const s=e[t];void 0!==s.mesh&&(this._addNodeRef(this.meshCache,s.mesh),void 0!==s.skin&&(n[s.mesh].isSkinnedMesh=!0)),void 0!==s.camera&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const s=n.clone(),r=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,s]of e.children.entries())r(s,t.children[n])};return r(n,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const s=e(t[n]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let s=0;s<t.length;s++){const r=e(t[s]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let s=this.cache.get(n);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":s=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e)}this.cache.add(n,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map(function(t,s){return n.getDependency(e,s)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[pn.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(e,r){n.load(U.resolveURL(t.uri,s.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const n=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+n)})}loadAccessor(e){const t=this,n=this.json,s=this.json.accessors[e];if(void 0===s.bufferView&&void 0===s.sparse){const e=Kn[s.type],t=Vn[s.componentType],n=!0===s.normalized,r=new t(s.count*e);return Promise.resolve(new a(r,e,n))}const r=[];return void 0!==s.bufferView?r.push(this.getDependency("bufferView",s.bufferView)):r.push(null),void 0!==s.sparse&&(r.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(r).then(function(e){const r=e[0],o=Kn[s.type],i=Vn[s.componentType],c=i.BYTES_PER_ELEMENT,l=c*o,u=s.byteOffset||0,h=void 0!==s.bufferView?n.bufferViews[s.bufferView].byteStride:void 0,p=!0===s.normalized;let d,f;if(h&&h!==l){const e=Math.floor(u/h),n="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+e+":"+s.count;let a=t.cache.get(n);a||(d=new i(r,e*h,s.count*h/c),a=new I(d,h/c),t.cache.add(n,a)),f=new R(a,o,u%h/c,p)}else d=null===r?new i(s.count*o):new i(r,u,s.count*o),f=new a(d,o,p);if(void 0!==s.sparse){const t=Kn.SCALAR,n=Vn[s.sparse.indices.componentType],c=s.sparse.indices.byteOffset||0,l=s.sparse.values.byteOffset||0,u=new n(e[1],c,s.sparse.count*t),h=new i(e[2],l,s.sparse.count*o);null!==r&&(f=new a(f.array.slice(),f.itemSize,f.normalized)),f.normalized=!1;for(let e=0,t=u.length;e<t;e++){const t=u[e];if(f.setX(t,h[e*o]),o>=2&&f.setY(t,h[e*o+1]),o>=3&&f.setZ(t,h[e*o+2]),o>=4&&f.setW(t,h[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}f.normalized=p}return f})}loadTexture(e){const t=this.json,n=this.options,s=t.textures[e].source,r=t.images[s];let o=this.textureLoader;if(r.uri){const e=n.manager.getHandler(r.uri);null!==e&&(o=e)}return this.loadTextureImage(e,s,o)}loadTextureImage(e,t,n){const s=this,r=this.json,o=r.textures[e],i=r.images[t],a=(i.uri||i.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=o.name||i.name||"",""===t.name&&"string"==typeof i.uri&&!1===i.uri.startsWith("data:image/")&&(t.name=i.uri);const n=(r.samplers||{})[o.sampler]||{};return t.magFilter=Gn[n.magFilter]||C,t.minFilter=Gn[n.minFilter]||O,t.wrapS=zn[n.wrapS]||ue,t.wrapT=zn[n.wrapT]||ue,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==$&&t.minFilter!==C,s.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(e,t){const n=this,s=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const o=s.images[e],i=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(void 0!==o.bufferView)a=n.getDependency("bufferView",o.bufferView).then(function(e){c=!0;const t=new Blob([e],{type:o.mimeType});return a=i.createObjectURL(t),a});else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(e){return new Promise(function(n,s){let o=n;!0===t.isImageBitmapLoader&&(o=function(e){const t=new ye(e);t.needsUpdate=!0,n(t)}),t.load(U.resolveURL(e,r.path),o,void 0,s)})}).then(function(e){var t;return!0===c&&i.revokeObjectURL(a),es(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw e});return this.sourceCache[e]=l,l}assignTexture(e,t,n,s){const r=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),r.extensions[pn.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[pn.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(o);o=r.extensions[pn.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),r.associations.set(o,t)}}return void 0!==s&&(o.colorSpace=s),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const s=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new oe,j.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new N,j.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(s||r||o){let e="ClonedMaterial:"+n.uuid+":";s&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),r&&(t.vertexColors=!0),o&&(t.flatShading=!0),s&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return q}loadMaterial(e){const t=this,n=this.json,s=this.extensions,r=n.materials[e];let o;const i={},a=[];if((r.extensions||{})[pn.KHR_MATERIALS_UNLIT]){const e=s[pn.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),a.push(e.extendParams(i,r,t))}else{const n=r.pbrMetallicRoughness||{};if(i.color=new u(1,1,1),i.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;i.color.setRGB(e[0],e[1],e[2],D),i.opacity=e[3]}void 0!==n.baseColorTexture&&a.push(t.assignTexture(i,"map",n.baseColorTexture,he)),i.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,i.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(a.push(t.assignTexture(i,"metalnessMap",n.metallicRoughnessTexture)),a.push(t.assignTexture(i,"roughnessMap",n.metallicRoughnessTexture))),o=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),a.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,i)})))}!0===r.doubleSided&&(i.side=f);const c=r.alphaMode||Yn;if(c===Zn?(i.transparent=!0,i.depthWrite=!1):(i.transparent=!1,c===$n&&(i.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&o!==z&&(a.push(t.assignTexture(i,"normalMap",r.normalTexture)),i.normalScale=new Ie(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;i.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&o!==z&&(a.push(t.assignTexture(i,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(i.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&o!==z){const e=r.emissiveFactor;i.emissive=(new u).setRGB(e[0],e[1],e[2],D)}return void 0!==r.emissiveTexture&&o!==z&&a.push(t.assignTexture(i,"emissiveMap",r.emissiveTexture,he)),Promise.all(a).then(function(){const n=new o(i);return r.name&&(n.name=r.name),es(n,r),t.associations.set(n,{materials:e}),r.extensions&&Qn(s,n,r),n})}createUniqueName(e){const t=ae.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,s=this.primitiveCache;function r(e){return n[pn.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return as(n,e,t)})}const o=[];for(let n=0,i=e.length;n<i;n++){const i=e[n],a=ns(i),l=s[a];if(l)o.push(l.promise);else{let e;e=i.extensions&&i.extensions[pn.KHR_DRACO_MESH_COMPRESSION]?r(i):as(new c,i,t),s[a]={primitive:i,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,n=this.json,s=this.extensions,r=n.meshes[e],o=r.primitives,i=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?Jn(this.cache):this.getDependency("material",o[e].material);i.push(t)}return i.push(t.loadGeometries(o)),Promise.all(i).then(function(n){const i=n.slice(0,n.length-1),a=n[n.length-1],c=[];for(let n=0,l=a.length;n<l;n++){const l=a[n],u=o[n];let h;const p=i[n];if(u.mode===Bn.TRIANGLES||u.mode===Bn.TRIANGLE_STRIP||u.mode===Bn.TRIANGLE_FAN||void 0===u.mode)h=!0===r.isSkinnedMesh?new fe(l,p):new G(l,p),!0===h.isSkinnedMesh&&h.normalizeSkinWeights(),u.mode===Bn.TRIANGLE_STRIP?h.geometry=un(h.geometry,we):u.mode===Bn.TRIANGLE_FAN&&(h.geometry=un(h.geometry,xe));else if(u.mode===Bn.LINES)h=new P(l,p);else if(u.mode===Bn.LINE_STRIP)h=new _(l,p);else if(u.mode===Bn.LINE_LOOP)h=new L(l,p);else{if(u.mode!==Bn.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);h=new re(l,p)}Object.keys(h.geometry.morphAttributes).length>0&&ts(h,r),h.name=t.createUniqueName(r.name||"mesh_"+e),es(h,r),u.extensions&&Qn(s,h,u),t.assignFinalMaterial(h),c.push(h)}for(let n=0,s=c.length;n<s;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return r.extensions&&Qn(s,c[0],r),c[0];const l=new x;r.extensions&&Qn(s,l,r),t.associations.set(l,{meshes:e});for(let e=0,t=c.length;e<t;e++)l.add(c[e]);return l})}loadCamera(e){let t;const n=this.json.cameras[e],s=n[n.type];if(s)return"perspective"===n.type?t=new ne(H.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===n.type&&(t=new te(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),es(t,n),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],n=[];for(let e=0,s=t.joints.length;e<s;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){const t=e.pop(),n=e,s=[],r=[];for(let e=0,o=n.length;e<o;e++){const o=n[e];if(o){s.push(o);const n=new V;null!==t&&n.fromArray(t.array,16*e),r.push(n)}}return new de(s,r)})}loadAnimation(e){const n=this.json,s=this,r=n.animations[e],o=r.name?r.name:"animation_"+e,i=[],a=[],c=[],l=[],u=[];for(let e=0,t=r.channels.length;e<t;e++){const t=r.channels[e],n=r.samplers[t.sampler],s=t.target,o=s.node,h=void 0!==r.parameters?r.parameters[n.input]:n.input,p=void 0!==r.parameters?r.parameters[n.output]:n.output;void 0!==s.node&&(i.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),c.push(this.getDependency("accessor",p)),l.push(n),u.push(s))}return Promise.all([Promise.all(i),Promise.all(a),Promise.all(c),Promise.all(l),Promise.all(u)]).then(function(e){const n=e[0],r=e[1],i=e[2],a=e[3],c=e[4],l=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],o=r[e],u=i[e],h=a[e],p=c[e];if(void 0===t)continue;t.updateMatrix&&t.updateMatrix();const d=s._createAnimationTracks(t,o,u,h,p);if(d)for(let e=0;e<d.length;e++)l.push(d[e])}return new t(o,void 0,l)})}createNodeMesh(e){const t=this.json,n=this,s=t.nodes[e];return void 0===s.mesh?null:n.getDependency("mesh",s.mesh).then(function(e){const t=n._getNodeRef(n.meshCache,s.mesh,e);return void 0!==s.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=s.weights.length;t<n;t++)e.morphTargetInfluences[t]=s.weights[t]}),t})}loadNode(e){const t=this,n=this.json.nodes[e],s=t._loadNodeShallow(e),r=[],o=n.children||[];for(let e=0,n=o.length;e<n;e++)r.push(t.getDependency("node",o[e]));const i=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([s,Promise.all(r),i]).then(function(e){const t=e[0],n=e[1],s=e[2];null!==s&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(s,os)});for(let e=0,s=n.length;e<s;e++)t.add(n[e]);return t})}_loadNodeShallow(e){const t=this.json,n=this.extensions,s=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],i=r.name?s.createUniqueName(r.name):"",a=[],c=s._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return c&&a.push(c),void 0!==r.camera&&a.push(s.getDependency("camera",r.camera).then(function(e){return s._getNodeRef(s.cameraCache,r.camera,e)})),s._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if(a=!0===r.isBone?new o:t.length>1?new x:1===t.length?t[0]:new ee,a!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=i),es(a,r),r.extensions&&Qn(n,a,r),void 0!==r.matrix){const e=new V;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);if(s.associations.has(a)){if(void 0!==r.mesh&&s.meshCache.refs[r.mesh]>1){const e=s.associations.get(a);s.associations.set(a,{...e})}}else s.associations.set(a,{});return s.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],s=this,r=new x;n.name&&(r.name=s.createUniqueName(n.name)),es(r,n),n.extensions&&Qn(t,r,n);const o=n.nodes||[],i=[];for(let e=0,t=o.length;e<t;e++)i.push(s.getDependency("node",o[e]));return Promise.all(i).then(function(e){for(let t=0,n=e.length;t<n;t++)r.add(e[t]);return s.associations=(e=>{const t=new Map;for(const[e,n]of s.associations)(e instanceof j||e instanceof ye)&&t.set(e,n);return e.traverse(e=>{const n=s.associations.get(e);null!=n&&t.set(e,n)}),t})(r),r})}_createAnimationTracks(e,t,n,s,r){const o=[],i=e.name?e.name:e.uuid,a=[];let c;switch(Wn[r.path]===Wn.weights?e.traverse(function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)}):a.push(i),Wn[r.path]){case Wn.weights:c=Q;break;case Wn.rotation:c=le;break;case Wn.translation:case Wn.scale:c=Se;break;default:if(1===n.itemSize)c=Q;else c=Se}const l=void 0!==s.interpolation?qn[s.interpolation]:E,u=this._getArrayFromAccessor(n);for(let e=0,n=a.length;e<n;e++){const n=new c(a[e]+"."+Wn[r.path],t.array,u,l);"CUBICSPLINE"===s.interpolation&&this._createCubicSplineTrackInterpolant(n),o.push(n)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=rs(t.constructor),n=new Float32Array(t.length);for(let s=0,r=t.length;s<r;s++)n[s]=t[s]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof le?Hn:Un)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function as(e,t,n){const s=t.attributes,r=[];function o(t,s){return n.getDependency("accessor",t).then(function(t){e.setAttribute(s,t)})}for(const t in s){const n=Xn[t]||t.toLowerCase();n in e.attributes||r.push(o(s[t],n))}if(void 0!==t.indices&&!e.index){const s=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(s)}return h.workingColorSpace,es(e,t),function(e,t,n){const s=t.attributes,r=new i;if(void 0===s.POSITION)return;{const e=n.json.accessors[s.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return;if(r.set(new Re(t[0],t[1],t[2]),new Re(o[0],o[1],o[2])),e.normalized){const t=rs(Vn[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new Re,t=new Re;for(let s=0,r=o.length;s<r;s++){const r=o[s];if(void 0!==r.POSITION){const s=n.json.accessors[r.POSITION],o=s.min,i=s.max;if(void 0!==o&&void 0!==i){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(i[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(i[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(i[2]))),s.normalized){const e=rs(Vn[s.componentType]);t.multiplyScalar(e)}e.max(t)}}}r.expandByVector(e)}e.boundingBox=r;const a=new me;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(r).then(function(){return void 0!==t.targets?function(e,t,n){let s=!1,r=!1,o=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(s=!0),void 0!==n.NORMAL&&(r=!0),void 0!==n.COLOR_0&&(o=!0),s&&r&&o)break}if(!s&&!r&&!o)return Promise.resolve(e);const i=[],a=[],c=[];for(let l=0,u=t.length;l<u;l++){const u=t[l];if(s){const t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;i.push(t)}if(r){const t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;c.push(t)}}return Promise.all([Promise.all(i),Promise.all(a),Promise.all(c)]).then(function(t){const n=t[0],i=t[1],a=t[2];return s&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=i),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}const cs=new class extends F{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new gn(e)}),this.register(function(e){return new vn(e)}),this.register(function(e){return new Mn(e)}),this.register(function(e){return new Sn(e)}),this.register(function(e){return new En(e)}),this.register(function(e){return new Tn(e)}),this.register(function(e){return new xn(e)}),this.register(function(e){return new wn(e)}),this.register(function(e){return new An(e)}),this.register(function(e){return new mn(e)}),this.register(function(e){return new bn(e)}),this.register(function(e){return new yn(e)}),this.register(function(e){return new Rn(e)}),this.register(function(e){return new In(e)}),this.register(function(e){return new dn(e)}),this.register(function(e){return new _n(e)}),this.register(function(e){return new Nn(e)})}load(e,t,n,s){const r=this;let o;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){const t=U.extractUrlBase(e);o=U.resolveURL(t,this.path)}else o=U.extractUrlBase(e);this.manager.itemStart(e);const i=function(t){s&&s(t),r.manager.itemError(e),r.manager.itemEnd(e)},a=new v(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(n){try{r.parse(n,o,function(n){t(n),r.manager.itemEnd(e)},i)}catch(e){i(e)}},n,i)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,s){let r;const o={},i={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Ln){try{o[pn.KHR_BINARY_GLTF]=new On(e)}catch(e){return void(s&&s(e))}r=JSON.parse(o[pn.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new is(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](c);t.name,i[t.name]=t,o[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],n=r.extensionsRequired||[];switch(t){case pn.KHR_MATERIALS_UNLIT:o[t]=new fn;break;case pn.KHR_DRACO_MESH_COMPRESSION:o[t]=new kn(r,this.dracoLoader);break;case pn.KHR_TEXTURE_TRANSFORM:o[t]=new Dn;break;case pn.KHR_MESH_QUANTIZATION:o[t]=new Fn;break;default:n.indexOf(t)>=0&&i[t]}}c.setExtensions(o),c.setPlugins(i),c.parse(n,s)}parseAsync(e,t){const n=this;return new Promise(function(s,r){n.parse(e,t,s,r)})}},ls=Array.from({length:3},()=>({loader:new Kt,isUsed:!1}));let us=[];const hs=Array.from({length:3},()=>({loader:new Te,isUsed:!1}));let ps=[];const ds=Array.from({length:3},()=>({loader:new r,isUsed:!1}));let fs=[];const ms=e=>ys(e,ls,us),gs=e=>ys(e,hs,ps),vs=e=>ys(e,ds,fs),ys=(e,t,n)=>{const s=t.find(e=>!e.isUsed);s?(s.isUsed=!0,e(s.loader)):n.push(t=>{e(t.loader),t.isUsed=!0})},Ts=(e,t,n)=>{const s=t.find(t=>t.loader===e);if(s)if(n.length>0){const e=n.shift();e&&e(s)}else s.isUsed=!1},xs=({list:e,onElementLoaded:t,onComplete:n,onError:s})=>{if(e.length>0){const{url:r}=e[0];cs.load(r,({scene:r,animations:o})=>{t({...e[0],gltfModel:{scene:r,animations:o}}),e.shift(),xs({list:e,onElementLoaded:t,onComplete:n,onError:s})},void 0,e=>s(String(e)))}else n()},ws=(e,t)=>{const n=[];return new Promise((s,r)=>{if(e.length>0){const o=[...e];for(;o.length>0;){const{url:e,id:i}=o[0],a=o[0];o.shift(),ms(o=>o.load(e,e=>{var r;r={...a,id:i,fbxModel:e},n.push(r),t(),Ts(o,ls,us),ls.some(e=>e.isUsed)||s(n)},void 0,t=>r(new Error(`Something wrong happened with an FBX model: ${i}, url: ${e}, error: ${t}`))))}}else s([])})},As={},bs={},Is={},Rs={},Ms={},Ss=({id:e,fbxModel:t})=>{As[e]=t},Es=e=>{const t=st(As[e]);return t.animations=[...As[e].animations],t},_s=({id:e,fbxModel:t})=>{Ms[e]=t.animations[0]},Ns=e=>Ms[e],Ls=({id:e,gltfModel:t})=>{bs[e]=t},Ps=e=>bs[e],Cs=({id:e,texture:t})=>{Is[e]=t},Os=e=>Is[e]||null,ks=({id:e,audioBuffer:t})=>{Rs[e]=t},Ds=e=>Rs[e]||null,Fs=({material:e,materialConfig:t={texture:{id:""},color:16777215,alphaTest:.5}})=>{"map"in e&&(e.map=t?.texture?.id?Os(t.texture.id):null),"alphaTest"in e&&(e.alphaTest=t?.alphaTest||.5),"color"in e&&(e.color=new u(t?.color||16777215))},Us=(e={materialType:void 0,texture:{id:"",flipY:!0},color:16777215,alphaTest:.5})=>{let t=null;if(e instanceof Array)t=e.map(e=>Us(e));else if(e.materialType){const n=e?.texture?.id?Os(e.texture.id):null;n&&(n.flipY=e?.texture?.flipY??!0),t=new e.materialType({map:n,alphaTest:e.alphaTest||.5,color:new u(e?.color||16777215)})}return t},js=()=>{Object.entries(Is).forEach(([e,t])=>{t.dispose(),delete Is[e]}),Object.entries(As).forEach(([e,t])=>{ze(t),delete As[e]}),Object.entries(bs).forEach(([e,t])=>{ze(t.scene),delete bs[e]})},Hs=({textures:e,gltfModels:t,fbxModels:n,fbxSkeletonAnimations:s,audio:r,onProgress:o,verbose:i=!0})=>new Promise(i=>{const a={fbxModels:[]},c=e.length+t.length+n.length+s.length+r.length;let l=0;const u=()=>{l++,o&&o(l/c)};((e,t)=>{const n=[];return new Promise((s,r)=>{if(e.length>0){const o=[...e];for(;o.length>0;){const{url:e,id:i}=o[0];o.shift(),gs(o=>o.load(e,r=>{var a;r.wrapS=ue,r.wrapT=ue,a={id:i,url:e,texture:r},n.push(a),t(),Ts(o,hs,ps),hs.some(e=>e.isUsed)||s(n)},void 0,t=>r(new Error(`Something wrong happened with a texture: ${i}, url: ${e}, error: ${t}`))))}}else s([])})})(e,u).then(e=>{e.forEach(e=>{e.texture.colorSpace=he,Cs(e)}),((e,t)=>{const n=[],s=e=>{n.push(e),t()};return new Promise((t,r)=>{xs({list:[...e],onElementLoaded:s,onComplete:()=>t(n),onError:e=>r(new Error(`Something wrong happened: ${e}`))})})})(t,u).then(e=>{e.forEach(e=>{const t=Us(e.material);let n=0;e.gltfModel.scene.traverse(s=>{if(s.isMesh){const r=s;r.castShadow=!0,r.receiveShadow=!0,r.material instanceof Array?r.material=t:r.material=t instanceof Array?t[n]:t||r.material,!t&&e.material&&Fs({material:r.material,materialConfig:e.material instanceof Array?e.material[n]:e.material}),n++}}),Ls(e)}),ws(s,u).then(e=>{e.forEach(e=>{_s(e)}),ws(n,u).then(e=>{e.forEach(e=>{const t=Us(e.material);let n=0;e.fbxModel.traverse(s=>{if(s.isMesh){const r=s;r.castShadow=!0,r.receiveShadow=!0,r.material instanceof Array?r.material=t:r.material=t instanceof Array?t[n]:t||r.material,!t&&e.material&&Fs({material:r.material,materialConfig:e.material instanceof Array?e.material[n]:e.material}),n++}}),Ss(e)}),a.fbxModels=[...e],((e,t)=>{const n=[];return new Promise((s,r)=>{if(e.length>0){const o=[...e];for(;o.length>0;){const{url:e,id:i}=o[0];o.shift(),vs(o=>o.load(e,r=>{var a;a={id:i,url:e,audioBuffer:r},n.push(a),t(),Ts(o,ds,fs),ds.some(e=>e.isUsed)||s(n)},void 0,t=>r(new Error(`Something wrong happened with an audio: ${i}, url: ${e}, error: ${t}`))))}}else s([])})})(r,u).then(e=>{e.forEach(e=>ks(e)),i(a)}).catch(e=>{})}).catch(e=>{})})})}).catch(e=>{})});class Bs extends _{constructor(e,t=1,n=16,s=2){const r=new c,o=new Float32Array(3*(3*(n+2*s)+3));r.setAttribute("position",new a(o,3));const i=new N({color:65280});super(r,[new N({color:16776960}),i]),this.audio=e,this.range=t,this.divisionsInnerAngle=n,this.divisionsOuterAngle=s,this.type="PositionalAudioHelper",this.update()}update(){const e=this.audio,t=this.range,n=this.divisionsInnerAngle,s=this.divisionsOuterAngle,r=H.degToRad(e.panner.coneInnerAngle),o=H.degToRad(e.panner.coneOuterAngle),i=r/2,a=o/2;let c,l,u=0,h=0;const p=this.geometry,d=p.attributes.position;function f(e,n,s,r){const o=(n-e)/s;for(d.setXYZ(u,0,0,0),h++,c=e;c<n;c+=o)l=u+h,d.setXYZ(l,Math.sin(c)*t,0,Math.cos(c)*t),d.setXYZ(l+1,Math.sin(Math.min(c+o,n))*t,0,Math.cos(Math.min(c+o,n))*t),d.setXYZ(l+2,0,0,0),h+=3;p.addGroup(u,h,r),u+=h,h=0}p.clearGroups(),f(-a,-i,s,0),f(-i,i,n,1),f(i,a,s,0),d.needsUpdate=!0,r===o&&(this.material[0].visible=!1)}dispose(){this.geometry.dispose(),this.material[0].dispose(),this.material[1].dispose()}}const Vs={loop:!1,volume:1,isMusic:!1};let Gs={};const zs={},Ks={masterVolume:1,musicVolume:1,effectsVolume:1},Xs=e=>{Gs=e},Ws=({audioId:e,position:t,radius:r=1,scene:o,camera:i,cacheId:a})=>{const c=Date.now();let l;if(a&&zs[a]){const{audio:e,container:n}=zs[a];l=e,l.isPlaying&&l.stop(),n&&t&&n.position.copy(t),zs[a].lastPlayedTime=c}else{const u=Ds(e);if(!u)return;const{loop:h,volume:p,isMusic:d}={...Vs,...Gs[e]},f=new s;let m;if(t&&o&&i){l=new ie(f),l.setRefDistance(r);const e=new ge(r,32,32);m=new G(e),m.visible=!1;const n=new Bs(l,r);l.add(n),m.position.copy(t),m.add(l),o.add(m),i.add(f)}else l=new n(f);l.setBuffer(u),l.setLoop(h||!1),l.setVolume((p||1)*Ks.masterVolume*(d?Ks.musicVolume:Ks.effectsVolume)),zs[a||e]={audio:l,audioId:e,container:m,lastPlayedTime:c}}l.play()},qs=e=>{const t=Ys(e);t.audio&&t.audio.isPlaying&&t.audio.stop()},Ys=e=>zs[e]||{audio:null,audioId:"",container:void 0,lastPlayedTime:0},$s=()=>{Object.keys(zs).forEach(e=>{const{audio:t,audioId:n}=Ys(e);if(t){const{volume:e,isMusic:s}={...Vs,...Gs[n]};t.setVolume((e||1)*Ks.masterVolume*(s?Ks.musicVolume:Ks.effectsVolume))}})},Zs=e=>{Ks.masterVolume=e,$s()},Js=e=>{Ks.musicVolume=e,$s()},Qs=e=>{Ks.effectsVolume=e,$s()},er={playAudio:Ws,stopAudio:qs,setMasterVolume:Zs,setMusicVolume:Js,setEffectsVolume:Qs};export{De as AssetsUtils,Fe as AudioUtils,_e as CallbackUtils,Ne as DisposeUtils,ke as GeomUtils,Le as ObjectUtils,Pe as TimeUtils,Ce as TokenUtils,Oe as Vector3Utils};